---
title: "GGMAP"
author: "Pedro Montenegro"
date: "9/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r message=FALSE, warning=FALSE}
library(ggmap)
library(tidyverse)
library(stringr)
library(RColorBrewer)
library(mapproj)
library(sp)
```


```{r}
load("../Otros/movimientos.Rdata")
load("/cloud/project/Otros/ubicaciones.RData")
map <- read_rds("../Otros/CRI_adm1.rds") %>% fortify() %>%
  filter(long < -82, long > -86, lat < 11.15, lat > 8)
#map <- getData(country = "CRI", level = 2)# obtener datos prov, canton
```

Se presentan datos transaccionales de compras en tarjeta de crédito, además, el comercio asociado, por medio del API google vamos a aproximar la longitud y latitud de los comercios que se registran en los datos sobre las compras de tárjeta de crédito.

Para utilizar el API google vamos a registrarnos en el [link](https://cloud.google.com/maps-platform/), posteriormente, se registra en r con register_google(key = "Credenciales propias"), la página tiene 365 días sin costo y con $300 para uso.

```{r}
glimpse(movimientos)
```

Primero, nos va a interesar solo las transacciones clasificadas como compras y efectúadas en Costa Rica. Además, al comercio se le va a sumar el monto total de compras efectuadas por los movimientos.

```{r}
puntos <- movimientos %>% filter(pais %in% c("188", "CRC", "CR", "CRI"),
  tipo != "Adelantos") %>%
  group_by(comercio) %>% summarise(monto = sum(monto_col)) %>%
  arrange(desc(monto)) #%>% filter(!(comercio %in% ubicaciones$comercio))
```

Paramétros para buscar en el API google maps. Nombre del comercio y Pais, se construye una matriz con la misma longitud para extraer la longitud y latitud.

```{r, eval=FALSE}
val_buscar <- paste0(puntos$comercio, ", Costa Rica")
valores <- matrix(nrow = NROW(val_buscar), ncol = 2)
colnames(valores) <- c("longitud", "latitud")
```

Función para extraer valores

```{r, eval=FALSE}
for (i in seq_along(val_buscar)) {
  query <- geocode(val_buscar[i], output = "all")  
    if (query$status == "OK") {
      valores[i, 1] <- as.numeric(query$results[[1]]$geometry$location$lng)
      valores[i, 2] <- as.numeric(query$results[[1]]$geometry$location$lat)
      print(valores[i, ])
    }
    else if (query$status == "OVER_QUERY_LIMIT") {
      valores <- valores[1:(i - 1), ]
      break
    }
}
```

# Gráfico 

```{r}
ubicaciones %>% 
  filter(lon < -82, lon > -86, lat < 11.15, lat > 8) %>%
  ggplot(aes(x = lon, y = lat))  +
  geom_polygon(data = map, aes(x = long, y = lat, group = group),
  fill = "seagreen", col = "white", alpha = 0.8) +
  geom_point(col = "#fab31e", size = 1.2) + coord_map() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(),
        panel.background = element_blank(), legend.position = "none",
        axis.title = element_blank(), panel.grid = element_blank()) +
  ggtitle("Ubicación de comercios donde compran los xx",
          "Tarjeta de crédito")
```


```{r}
mov <- movimientos %>% select(mcc_cat, comercio) %>% group_by(comercio) %>% 
  slice(1)

top10 <- c("SUPERMERCADOS Y ABARROTES",
           "ESTACIONES DE GASOLINA",
           "TIENDA DE DEPARTAMENTOS",
           "RESTAURANTES",
           "SERVICIOS PUBLICOS",
           "FARMACIAS",
           "AEROLINEAS",
           "HOTELES Y CABINAS",
           "UNIVERSIDADES",
           "FERRETERIAS"
)

top5 <- c("SUPERMERCADOS Y ABARROTES",
           "ESTACIONES DE GASOLINA",
           "TIENDA DE DEPARTAMENTOS",
           "RESTAURANTES",
           "SERVICIOS PUBLICOS"
)
ubicaciones2 <- ubicaciones %>% left_join(mov, by = "comercio") %>% 
  mutate(cat = ifelse(mcc_cat %in% top5, mcc_cat, "OTROS"),
         cat = str_to_title(cat))


ubicaciones2 %>% filter(lon < -82, lon > -86, lat < 11.15, lat > 8) %>% 
  ggplot(aes(x = lon, y = lat))  + 
  geom_polygon(data = map, aes(x = long, y = lat, group = group),
               fill = "white", col = "black", alpha = 0.8) + 
  geom_point(aes(col = as.factor(cat), shape = as.factor(cat)), size = 1.5) + coord_map() + 
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.background = element_blank(), legend.position = "right",
        axis.title = element_blank(), panel.grid = element_blank()) +
  ggtitle("Ubicación aproximada de comercios donde compran los xx",
          "Tarjeta de crédito") + scale_color_manual(name = "",
        values =  RColorBrewer::brewer.pal(7, "Set1"))
```

